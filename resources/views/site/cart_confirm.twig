{% extends 'site.main.twig' %}{% block content %}	<div class="container">		<div class="row">			<div class="col">				<form method="post">					{{ csrf_field() }}					<div class="featured-boxes">						<div class="row">							<div class="col">								<div class="featured-box featured-box-primary text-left mt-2">									<div class="box-content">										<h4 class="color-primary font-weight-semibold text-4 text-uppercase mb-3">Finalizar compra</h4>										<table class="shop_table cart table table-bordered" style="width: 100%;">											<thead>												<tr>													<th class="product-name" colspan="2">Produto</th>													<th class="product-price text-right">Valor</th>													<th class="product-quantity text-center">Quatidade</th>													<th class="product-subtotal text-right">Subtotal</th>												</tr>											</thead>											<tbody>												{% for cartProduct in cart.cartProducts %}													{% set stockQuantity = cartProduct.variation.stock_quantity %}													<tr class="cart_table_item">														<td class="product-thumbnail" width="100">															<img alt="" class="img-fluid" src="{{ cartProduct.variation.image }}">														</td>														<td class="product-name">															<strong>{{ cartProduct.product.name }}</strong>															<br>															{% for item in cartProduct.variation.items %}																{{ item.productGrid.grid.description }}: {{ item.gridVariation.description }}<br>															{% endfor %}														</td>														{% if stockQuantity <= 0 %}															<td colspan="3">																<div class="alert alert-info alert-sm">																	Produto indisponível.																	<a href="{{ route('cart.product.remove', cartProduct.id) }}">Deseja remover do carrinho?</a>																</div>															</td>														{% else %}															<td class="product-price text-right">																<span class="amount">R$ {{ cartProduct.variation.final_price_formated }}</span>																{% if cartProduct.variation.discount_percent > 0 %}																	<br>																	<del>																		<small>																			<span class="amount">R$ {{ cartProduct.variation.value_formated }}</span>																		</small>																	</del>																{% endif %}															</td>															<td class="product-quantity text-center" width="150">																{{ cartProduct.quantity }}															</td>															<td class="product-subtotal text-right">																<span class="amount">R$ {{ cartProduct.subtotal_value_formated }}</span>															</td>														{% endif %}													</tr>												{% else %}													<tr>														<td colspan="5" class="text-center">Nenhum produto no carrinho</td>													</tr>												{% endfor %}												<tr>													<td colspan="4" class="text-right font-weight-bold">Total</td>													<td class="text-right font-weight-bold">R$ {{ cart.total_value_formated }}</td>												</tr>											</tbody>										</table>									</div>								</div>							</div>						</div>					</div>					<div class="">						<div class="row">							<div class="col-lg-6">								<div class="featured-box text-left mt-3 mt-lg-4">									<div class="box-content">										<h4 class="color-primary font-weight-semibold text-4 text-uppercase mb-3">Selecione o Endereço</h4>										<div class="form-row">											<div class="form-group col">												{% if addresses is  not null %}													<select class="form-control" id="address" name="address_id">														<option value="">Selecione</option>														{% for address in addresses %}															<option value="{{ address.id }}" data-cep="{{ address.postal_code }}" {% if old('address_id') == address.id or old('address_id') is null and input_get('cep') == address.postal_code or old('address_id') is null and input_get('cep') is null and address.main %}selected="selected"{% endif %}>{{ address.complete_address }}</option>														{% endfor %}													</select>												{% else %}													Nenhum endereço cadastrado												{% endif %}											</div>										</div>										<div class="form-row">											<div class="form-group col-8">												<div id="shipping-options"></div>											</div>											<div class="form-group col-4 text-right">												<a href="#addAddress" data-toggle="modal" class="btn btn-primary btn-modern text-uppercase">													Novo Endereço												</a>											</div>										</div>									</div>								</div>							</div>							<div class="col-lg-6">								<div class="featured-box text-left mt-3 mt-lg-4">									<div class="box-content">										<h4 class="color-primary font-weight-semibold text-4 text-uppercase mb-3">Resumo do Pedido</h4>										<table class="cart-totals" style="width: 100%;">											<tbody>												<tr>													<th>														<strong class="text-dark">Subtotal</strong>													</th>													<td>														<strong class="text-dark">															<span class="amount" id="subtotal-value" data-value="{{ cart.total_value }}">R$ {{ cart.total_value_formated }}</span>														</strong>													</td>												</tr>												<tr>													<th>Frete</th>													<td id="shipping-value">-</td>												</tr>												<tr>													<th>														<strong class="text-dark">Total</strong>													</th>													<td>														<strong class="text-dark">															<span id="total-value">-</span>														</strong>													</td>												</tr>											</tbody>										</table>									</div>								</div>							</div>						</div>					</div>					<div class="row">						<div class="col">							<div class="text-left">								<a href="{{ route('cart') }}" class="btn btn-default btn-modern text-uppercase">									<i class="fas fa-angle-left ml-1"></i> Voltar para Carrinho								</a>							</div>						</div>						<div class="col">							<div class="text-right">								<button type="submit" id="btn-create-order" class="btn btn-primary btn-modern text-uppercase" disabled="disabled">									Finalizar Pedido <i class="fas fa-angle-right ml-1"></i>								</button>							</div>						</div>					</div>				</form>			</div>		</div>	</div>	<div class="modal fade" id="addAddress" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">		<div class="modal-dialog" role="document">			<form role="form" class="needs-validation" id="form-add-address" method="POST">				{{ csrf_field() }}				<div class="modal-content">					<div class="modal-header">						<h5 class="modal-title" id="exampleModalLabel">Novo Endereço</h5>						<button type="button" class="close" data-dismiss="modal" aria-label="Close">							<span aria-hidden="true">&times;</span>						</button>					</div>					<div class="modal-body">						<div class="form-group row">							<div class="col-lg-4">								<label>CEP</label>								<input name="cep" id="cep" class="form-control cep" type="text" value="{{ old('cep') }}" onblur="findCep(this.value);" required="required">							</div>							<div class="col-lg-8">								<label>Endereço</label>								<input name="street" id="street" class="form-control" type="text" value="{{ old('street') }}" placeholder="Rua..." required="required">							</div>						</div>						<div class="form-group row">							<div class="col-lg-6">								<label>Complemento</label>								<input name="complement" class="form-control" type="text" value="{{ old('complement') }}" placeholder="Complemento, Ex: Apto 2014 - Torre Sul">							</div>							<div class="col-lg-6">								<label>Referência</label>								<input name="reference" class="form-control" type="text" value="{{ old('reference') }}" placeholder="Referência, Ex: Em frente ao colégio Estadual">							</div>						</div>						<div class="form-group row">							<div class="col-lg-3">								<label>Número</label>								<input name="number" class="form-control" type="text" value="{{ old('number') }}">							</div>							<div class="col-lg-3">								<label>Cidade</label>								<input name="city" id="city" class="form-control" type="text" value="{{ old('city') }}" required="required">							</div>							<div class="col-lg-3">								<label>Estado</label>								<input name="state" id="uf" class="form-control" type="text" value="{{ old('state') }}" required="required">							</div>							<div class="col-lg-3">								<label>Bairro</label>								<input name="district" id="district" class="form-control" type="text" value="{{ old('district') }}" placeholder="Bairro" required="required">							</div>						</div>					</div>					<div class="modal-footer">						<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>						<button type="submit" id="btn-add-address" class="btn btn-primary">Cadastrar</button>					</div>				</div>			</form>		</div>	</div>{% endblock content %}{% block footer %}	<script type="text/javascript" src="/general/components/jquery-mask-plugin/dist/jquery.mask.js"></script>	<script type="text/javascript">		localeSettings = {			minimumFractionDigits: 2,			style: 'currency',			currency: 'BRL'		};		$('.cep').mask('00000-000');		function clearForm() {			document.getElementById('district').value=("");			document.getElementById('city').value=("");			document.getElementById('street').value=("");			document.getElementById('uf').value=("");		}		function callback(data) {			if (!("erro" in data)) {				document.getElementById('district').value=(data.bairro);				document.getElementById('city').value=(data.localidade);				document.getElementById('street').value=(data.logradouro);				document.getElementById('uf').value=(data.uf);			} else {				clearForm();				toastr.error("CEP não encontrado.");			}		}		function findCep(valor) {			var cep = valor.replace(/\D/g, '');			if (cep != "") {				var cepValidate = /^[0-9]{8}$/;				if(cepValidate.test(cep)) {					document.getElementById('district').value="...";					document.getElementById('city').value="...";					document.getElementById('street').value="...";					document.getElementById('uf').value="...";					var script = document.createElement('script');					script.src = 'https://viacep.com.br/ws/'+ cep + '/json/?callback=callback';					document.body.appendChild(script);				} else {					clearForm();					alert("Formato de CEP inválido.");				}			} else {				clearForm();			}		}		function calculateShipping(cep)		{			$('#shipping-value').html('-');			$('#total-value').html('-');			$('#btn-create-order').attr({'disabled': 'disabled'});			let shippingOptions = $('#shipping-options');			shippingOptions.html('');			$.ajax({				type: 'get',				url: '/carrinho/calculate-freight',				dataType: 'json',				data: { cep: cep },				beforeSend: function () {					let btn = $('#btn-add-address');					shippingOptions.attr({'disabled': 'disabled'}).prepend(						$('<div>').addClass('loading-shipping-calculate').append(							$('<span>').addClass('fa fa-fw fa-spin fa-spinner').text(),							' Calculando..'						)					);				},				complete: function () {					shippingOptions.removeAttr('disabled').children('.loading-shipping-calculate').remove();				},				success: function (data) {					$('#btn-calculate-freight').html('Calcular').removeAttr('disabled');					if (data.error === true) {						toastr.error(data.message);						$('#shipping-value').html('-');						$('#total-value').html('-');						shippingOptions.addClass('d-none');						return false;					}					for (let shippingType in data) {						let dataShipping = data[shippingType];						let value = dataShipping.value;						var brlValue = 'Grátis';						if (value > 0) {							brlValue = value.toLocaleString('pt-BR', localeSettings);						}						if (dataShipping.warning != undefined && data.warning != '') {							toastr.warning(data.warning);						}						shippingOptions.append(								$('<div>').addClass('form-check').append(									$('<input>').addClass('form-check-input').attr({										'type': 'radio',										'name': 'shipping_id',										'id': 'type' + shippingType,										'data-value': dataShipping.value									}).val(shippingType),									$('<label>')										.addClass('form-check-label')										.attr({'for': 'type' + shippingType})										.html(dataShipping.description + ' - <strong>' + brlValue + '</strong> - Prazo: ' + dataShipping.deadline + ' dias úteis')								)						);					}				}			});		}		function handleErrors(data)		{			let responseJson = data.responseJSON;			if (typeof responseJson.errors !== 'object' && responseJson.message !== undefined) {				toastr.error(responseJson.message);				return;			}			let errors = responseJson.errors;			for (let field in errors) {				toastr.error(errors[field][0]);			}		}		$('#form-add-address').submit(function(e) {			e.preventDefault();			let btn = $('#btn-add-address');			btn.attr({'disabled': 'disabled'}).prepend(				$('<span>').addClass('fa fa-fw fa-spin fa-spinner loading'), ' '			);			$.ajax({				url: '{{ route('panel.address.store.json') }}',				type: 'POST',				dataType: 'json',				data: $(this).serialize(),				complete: function (data) {					btn.removeAttr('disabled').children('.loading').remove();				},				success: function (data) {					$('#address').append(						$('<option>').val(data.id).attr({'data-cep':data.postal_code}).text(data.complete_address).prop('selected', 'selected')					);					$('#addAddress').modal('toggle');					$('#form-add-address input, #form-add-address select').val('');					calculateShipping(data.postal_code);					toastr.success('Endereço criado com sucesso!');				},				error: function (data) {					handleErrors(data)				}			});			return false;		});		$(document).on('change', '.form-check-input', function () {			let value = parseFloat($(this).attr('data-value'));			let subtotal = parseFloat('{{ cart.total_value }}');			let totalValue = value + subtotal;			let shippingValue = 'Grátis';			if (value > 0) {				shippingValue = value.toLocaleString('pt-BR', localeSettings);			}			$('#shipping-value').html(shippingValue);			$('#total-value').html(totalValue.toLocaleString('pt-BR', localeSettings));			$('#btn-create-order').removeAttr('disabled');		});		$('#address').change(function () {			let cep = $(this).children('option:selected').attr('data-cep');			if (cep == '') {				toastr.error('');			}			calculateShipping(cep);		});		let cep = $('#address option:selected').attr('data-cep');		if (cep !== undefined && cep !== '') {			calculateShipping(cep);		}	</script>{% endblock footer %}